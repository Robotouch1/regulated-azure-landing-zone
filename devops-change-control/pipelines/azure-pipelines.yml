trigger: none

variables:
  agentPool: 'self-hosted-local'
  azureServiceConnection: 'sc-prod-deployer1'
  rg_protected: 'rg-prod-test'
  st_protected: 'stsecdiagtest'

  # IMPORTANT: because your repo is "regulated-azure-landing-zone"
  # and the project lives under "devops-change-control/..."
  templatePath: 'devops-change-control/bicep/main.bicep'

stages:
- stage: WhatIf
  displayName: What-If
  jobs:
  - job: whatif
    displayName: What-If Deployment
    pool:
      name: $(agentPool)
    steps:
    - checkout: self
      clean: true

    - task: AzureCLI@2
      displayName: "What-if (preview changes)"
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          echo "Agent: $AGENT_NAME"
          echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
          echo "Target RG: $(rg_protected)"
          echo "Storage: $(st_protected)"

          az --version
          echo "Azure account context:"
          az account show --query "{name:name, id:id, tenantId:tenantId}" -o json

          TEMPLATE="$(Build.SourcesDirectory)/$(templatePath)"
          echo "Using template: $TEMPLATE"
          ls -la "$(Build.SourcesDirectory)/devops-change-control/bicep" || true

          az deployment group what-if \
            --resource-group "$(rg_protected)" \
            --template-file "$TEMPLATE" \
            --parameters storageName="$(st_protected)" publicNetworkAccess="Enabled" allowBlobPublicAccess=true

- stage: Deploy
  displayName: Deploy
  dependsOn: WhatIf
  condition: succeeded()
  jobs:
  - job: deploy
    displayName: Deploy (expected to be denied by policy)
    pool:
      name: $(agentPool)
    steps:
    - checkout: self
      clean: true

    - task: AzureCLI@2
      displayName: "Deploy (expected policy deny)"
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          echo "Agent: $AGENT_NAME"
          echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
          echo "Deploying to RG: $(rg_protected)"
          echo "Storage: $(st_protected)"

          TEMPLATE="$(Build.SourcesDirectory)/$(templatePath)"
          echo "Using template: $TEMPLATE"

          az deployment group create \
            --resource-group "$(rg_protected)" \
            --template-file "$TEMPLATE" \
            --parameters storageName="$(st_protected)" publicNetworkAccess="Enabled" allowBlobPublicAccess=true
