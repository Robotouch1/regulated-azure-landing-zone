trigger: none

variables:
  agentPool: 'self-hosted-local'
  azureServiceConnection: 'sc-prod-deployer1'
  rg_protected: 'rg-prod-test'
  st_protected: 'stsecdiagtest'
  templatePath: 'devops-change-control/bicep/main.bicep'

stages:
- stage: WhatIf
  displayName: What-If (advisory)
  jobs:
  - job: whatif
    displayName: What-If Deployment (should not block)
    pool:
      name: $(agentPool)
    steps:
    - checkout: self
      clean: true

    - task: AzureCLI@2
      displayName: "What-if (preview changes) â€” continue even if denied"
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -uo pipefail

          echo "Agent: $AGENT_NAME"
          echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
          echo "Target RG: $(rg_protected)"
          echo "Storage: $(st_protected)"

          TEMPLATE="$(Build.SourcesDirectory)/$(templatePath)"
          echo "Using template: $TEMPLATE"

          # Run what-if, but DO NOT fail the stage if policy denies
          set +e
          az deployment group what-if \
            --resource-group "$(rg_protected)" \
            --template-file "$TEMPLATE" \
            --parameters storageName="$(st_protected)" publicNetworkAccess="Enabled" allowBlobPublicAccess=true
          RC=$?
          set -e

          if [ $RC -ne 0 ]; then
            echo "WARNING: what-if returned exit code $RC (likely policy deny). Continuing pipeline by design."
          else
            echo "What-if succeeded."
          fi

          exit 0

- stage: Deploy
  displayName: Deploy (enforced)
  dependsOn: WhatIf
  condition: succeeded()
  jobs:
  - job: deploy
    displayName: Deploy (expected policy deny)
    pool:
      name: $(agentPool)
    steps:
    - checkout: self
      clean: true

    - task: AzureCLI@2
      displayName: "Deploy (expected policy deny)"
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          echo "Agent: $AGENT_NAME"
          echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
          echo "Deploying to RG: $(rg_protected)"
          echo "Storage: $(st_protected)"

          TEMPLATE="$(Build.SourcesDirectory)/$(templatePath)"
          echo "Using template: $TEMPLATE"

          az deployment group create \
            --resource-group "$(rg_protected)" \
            --template-file "$TEMPLATE" \
            --parameters storageName="$(st_protected)" publicNetworkAccess="Enabled" allowBlobPublicAccess=true
